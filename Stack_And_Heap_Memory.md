# 스택 메모리 vs 힙 메모리

<br>

## 스택 메모리 (Stack memory)

- 스택은 지역 변수와 매개변수가 저장되는 공간이며 <b>예약된 지역 메모리 공간</b>이다. 함수 호출과 반환이 이 메모리에서 일어나며 스택은  데이터를 push & pop 할 때 스택 포인터를 단순히 위아래로 옮김으로써 스택을 동작 시킨다.

- 미리 예약된 메모리이기 때문에 메모리 할당이 따로 필요없으며 사용한 메모리를 굳이 반납하지 않고 단순히 스택 포인터를 감소시킴으로써 스택 공간을 제한시킨다. 스택 포인터가 증가하면 사용했던 공간을 단순히 덮어 쓰는 경우가 많다.

- 또한 객체는 속한 영역(scope)을 벗어나면 스택 포인터의 위치가 바뀜에 따라 알아서 사라진다. 따라서 함수를 통해 메모리가 할당되고 해제되는 힙 메모리에 비해 매우 빠르다는 이점을 가지고 있다.

- 스택에 저장되는 지역 변수와 매개 변수는 그 <b>크기가 컴파일 타임에 정해지기 때문에</b> 스택은 미리 정해진 크기를 따라 움직이게 된다.
따라서 실행 중에 메모리를 계산하거나 판단할 일이 없기에 힙 메모리 할당보다 훨씬 빠른 이유기도 하다.

- 힙에 비해 메모리의 크기가 매우 적다는 단점을 가지고 있다.  그리고 메모리 주소 범위를 벗어나게 되면 overflow가 발생할 수 있다.


<br>
  


## 힙 메모리 (Heap memory)

- 힙 메모리는 동적으로 할당된 메모리가 저장되는 공간이다. malloc 또는 new를 통해 동적으로 할당된 메모리는 Heap 영역에 저장되며 <b>스택과 달리 scope를 벗어나도 자동으로 사라지지 않는다</b>. 따라서 힙 메모리는 할당한 사람이 책임지고 사용이 끝나면 해제해주어야 한다.

- 할당한 메모리를 사용 후에 반환해주지 않으면 프로그램이 종료될 때 반환되며, <b>종료 전까지 반환되지 않은 메모리가 메모리릭의 원인</b>이다.

- 힙 메모리는 스택에 비해 저장할 수 있는 공간이 훨씬 많다. 

- 힙 메모리는 운영체제가 메모리를 훑으면서 할당 가능한 연속된 메모리 공간을 찾은 뒤에 반환해주어야 하기 때문에 스택에 비해 느리다. 100mb가 필요하다면 연속된 100mb 공간을 찾아 반환해주어야 한다.

- 또한 <b>힙 메모리의 재할당이 자주 발생하면 메모리 단편화를 일으키키도 한다</b>. 메모리 단편화란 남아있는 메모리는 충분하지만 연속된 메모리가 남아있지 않고 띄엄띄엄 있어 배열과 같은 연속된 메모리를 할당해줄 수 없는 현상을 말한다.

<br>

## RAII (Resource Acquisition Is Initializaion)

C++에는 <b>RAII</b>라는 패턴 및 기법이 있다. <i>Resource Acquisition Is Initializaion: "자원 획득은 초기화"</i> 라는 의미이다.
자원은 메모리를 뜻하며, 조금 풀어서 써보면 <i>"자원 획득은 초기화 시점에 일어나야 한다", "초기화는 객체의 올바른 자원 획득을 보장해야한다"</i> 정도로 해석할 수 있다. 

<br>
단순히 위의 의미에서 끝날 수도 있지만 이 RAII라는 기법은 좀 더 깊게 생각해주어야 한다. 이는 전체적으로 메모리 관리에 대한 기법 및 패턴이라는 것을 기억해야 한다. 메모리 중에서도 굳이 따지자면 스택보단 힙 메모리 관리에 대한 필요성이 좀 더 크지만, 원리가 스택의 특징과 비슷하므로 둘 다 해당된다. 
<br><br>

우리가 지역 변수 또는 객체를 생성하면<b>(= 자원을 획득하면)</b> 이 객체는 자기가 속한 scope를 벗어나면 자동으로 사라지는 특징<b>(= 자원을 반환)</b>을 가지고 있다. 이는 클래스에서 생성자와 소멸자의 관계로도 볼 수 있다.
객체는 범위(scope)를 벗어나면 자동으로 소멸자가 호출되며 객체가 파괴되는 성질을 가지고 있다. 이 성질을 이용하여 <b>생성자에서 자원을 할당하고 소멸자에서 자원을 반환함으로써 마치 스택처럼 자원의 순환을 보장</b>해주도록 하는 것이다.

<br>
스택 메모리의 객체는 영역을 벗어나면 자동으로 해제되지만, 힙 메모리는 자동으로 해제되지 않기 때문에 생성자와 소멸자에 힙 메모리를 할당 및 해제하는 방식으로 스택처럼 메모리가 자동으로 순환되도록 해준다. 
<br><br>

정리하자면, <br>
RAII라는 이름에선 자원 획득과 초기화에 관한 것이 전부이지만 이는 객체가 초기화 시 자원을 획득했다면 파괴 시엔 자원을 반환한 상태가 되어야 한다는 것이다. RAII는 생성자와 소멸자에만 한정하는 것이 아니라, 메모리를 할당했으면 메모리 해제가 보장되도록 하는 모든 상황에서 적용될 수 있다.